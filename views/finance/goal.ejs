<% layout("./layouts/boilerplate") -%>

<div class="container bg-light p-4 rounded">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="text-center">Financial Goals</h2>
            <p class="text-muted text-center">Track your progress and stay motivated</p>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4>Add New Goal</h4>
                </div>
                <div class="card-body">
                    <form action="/finance/goals" method="POST" class="needs-validation" novalidate>
                        <div class="mb-3">
                            <label for="title" class="form-label">Goal Title</label>
                            <input type="text" class="form-control" id="title" name="goal[title]" required>
                            <div class="invalid-feedback">
                                Please enter a goal title.
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="targetAmount" class="form-label">Target Amount (₹)</label>
                            <input type="number" class="form-control" id="targetAmount" name="goal[targetAmount]" required>
                            <div class="invalid-feedback">
                                Please enter a target amount.
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="currentAmount" class="form-label">Current Savings (₹)</label>
                            <input type="number" class="form-control" id="currentAmount" name="goal[currentAmount]" value="0">
                        </div>
                        <div class="mb-3">
                            <label for="deadline" class="form-label">Target Date</label>
                            <input type="date" class="form-control" id="deadline" name="goal[deadline]" required>
                            <div class="invalid-feedback">
                                Please select a target date.
                            </div>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Create Goal</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <% if (goals && goals.length > 0) { %>
        <div class="row">
            <% goals.forEach(goal => { %>
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><%= goal.title %></h5>
                            <form action="/finance/goals/<%= goal.id %>?_method=DELETE" method="POST" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </form>
                        </div>
                        <div class="card-body">
                            <h6 class="card-subtitle mb-3 text-muted">
                                Target: ₹<%= goal.targetAmount.toLocaleString('en-IN') %>
                            </h6>
                            
                            <% 
                                const progressPercent = (goal.currentAmount / goal.targetAmount) * 100;
                                let progressClass = "bg-danger";
                                if (progressPercent >= 75) {
                                    progressClass = "bg-success";
                                } else if (progressPercent >= 40) {
                                    progressClass = "bg-warning";
                                }
                                
                                const deadline = new Date(goal.deadline.seconds * 1000);
                                const today = new Date();
                                const daysLeft = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
                            %>
                            
                            <div class="mb-3">
                                <div class="progress" style="height: 25px;">
                                    <div class="progress-bar <%= progressClass %>" role="progressbar" 
                                         style="width: '<%= progressPercent %>%'"; 
                                         aria-valuenow="<%= progressPercent %>" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                        <%= Math.round(progressPercent) %>%
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between mb-3">
                                <span>Current: ₹<%= goal.currentAmount.toLocaleString('en-IN') %></span>
                                <span>Remaining: ₹<%= (goal.targetAmount - goal.currentAmount).toLocaleString('en-IN') %></span>
                            </div>
                            
                            <div class="mb-3">
                                <% if (daysLeft > 0) { %>
                                    <p class="text-muted mb-2">
                                        <i class="fa-regular fa-calendar"></i>
                                        <%= daysLeft %> days left (Due: <%= deadline.toLocaleDateString() %>)
                                    </p>
                                    
                                    <% 
                                        const dailyAmountNeeded = (goal.targetAmount - goal.currentAmount) / daysLeft;
                                    %>
                                    <p class="small mb-0">
                                        Need to save ₹<%= Math.ceil(dailyAmountNeeded).toLocaleString('en-IN') %> daily to reach goal
                                    </p>
                                <% } else if (daysLeft === 0) { %>
                                    <p class="text-warning mb-0">
                                        <i class="fa-solid fa-exclamation-circle"></i>
                                        Goal due today!
                                    </p>
                                <% } else { %>
                                    <p class="text-danger mb-0">
                                        <i class="fa-solid fa-exclamation-triangle"></i>
                                        Goal overdue by <%= Math.abs(daysLeft) %> days
                                    </p>
                                <% } %>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#updateModal<%= goal.id %>">
                                    <i class="fa-solid fa-plus"></i> Update Progress
                                </button>
                                <a href="/finance/goals/<%= goal.id %>/edit" class="btn btn-sm btn-outline-primary">
                                    <i class="fa-solid fa-edit"></i> Edit Goal
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Update Progress Modal -->
                <div class="modal fade" id="updateModal<%= goal.id %>" tabindex="-1" aria-labelledby="updateModalLabel<%= goal.id %>" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="updateModalLabel<%= goal.id %>">Update Progress: <%= goal.title %></h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <form action="/finance/goals/<%= goal.id %>/update" method="POST">
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="currentAmount<%= goal.id %>" class="form-label">Current Amount (₹)</label>
                                        <input type="number" class="form-control" id="currentAmount<%= goal.id %>" name="currentAmount" value="<%= goal.currentAmount %>" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="notes<%= goal.id %>" class="form-label">Notes (Optional)</label>
                                        <textarea class="form-control" id="notes<%= goal.id %>" name="notes" rows="3"></textarea>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-success">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            <% }) %>
        </div>
        
        <!-- Summary Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h4>Goals Summary</h4>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-4 mb-3">
                                <div class="p-3 border rounded">
                                    <h5>Total Goals</h5>
                                    <h2><%= goals.length %></h2>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="p-3 border rounded">
                                    <h5>Total Savings</h5>
                                    <h2>₹<%= goals.reduce((sum, goal) => sum + goal.currentAmount, 0).toLocaleString('en-IN') %></h2>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="p-3 border rounded">
                                    <h5>Total Target</h5>
                                    <h2>₹<%= goals.reduce((sum, goal) => sum + goal.targetAmount, 0).toLocaleString('en-IN') %></h2>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    <% } else { %>
        <div class="row mt-4">
            <div class="col-md-8 offset-md-2">
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="fa-solid fa-piggy-bank fa-4x text-muted mb-3"></i>
                        <h4>No financial goals added yet</h4>
                        <p class="text-muted">Create your first goal by filling out the form above!</p>
                    </div>
                </div>
            </div>
        </div>
    <% } %>
</div>

<!-- Form Validation Script -->
<script>
    // Example starter JavaScript for disabling form submissions if there are invalid fields
    (function () {
        'use strict'

        // Fetch all the forms we want to apply custom Bootstrap validation styles to
        const forms = document.querySelectorAll('.needs-validation')

        // Loop over them and prevent submission
        Array.from(forms).forEach(form => {
            form.addEventListener('submit', event => {
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()
                }

                form.classList.add('was-validated')
            }, false)
        })
    })()
</script>

<!-- Goal Progress Chart (Optional) -->
<% if (goals && goals.length > 0) { %>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get goals data from the server-side
        const goalsData = JSON.stringify(goals.map(g => ({
            title: "<%= g.title %>",
            current: "<%= g.currentAmount %>",
            target: "<%= g.targetAmount %>"
        })));
        
        // Only show top 5 goals in chart
        const chartData = goalsData.slice(0, 5);
        
        // Create chart
        const ctx = document.getElementById('goalsChart');
        if (ctx) {
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.map(g => g.title),
                    datasets: [
                        {
                            label: 'Current Amount',
                            data: chartData.map(g => g.current),
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Target Amount',
                            data: chartData.map(g => g.target),
                            backgroundColor: 'rgba(255, 99, 132, 0.7)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    });
</script>
<% } %>